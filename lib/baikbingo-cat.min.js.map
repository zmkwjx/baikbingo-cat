{"version":3,"file":"baikbingo-cat.min.js","sources":["../node_modules/uuid/dist/esm-browser/rng.js","../node_modules/uuid/dist/esm-browser/regex.js","../node_modules/uuid/dist/esm-browser/validate.js","../node_modules/uuid/dist/esm-browser/stringify.js","../node_modules/uuid/dist/esm-browser/v4.js","../packages/cat-core/client/index.ts","../packages/cat-core/server/index.ts","../packages/cat-core/store/index.ts","../packages/cat-core/index.ts"],"sourcesContent":["// Unique ID creation requires a high quality random # generator. In the browser we therefore\n// require the crypto API and do not support built-in fallback to lower quality random number\n// generators (like Math.random()).\nvar getRandomValues;\nvar rnds8 = new Uint8Array(16);\nexport default function rng() {\n  // lazy load so that environments that need to polyfill have a chance to do so\n  if (!getRandomValues) {\n    // getRandomValues needs to be invoked in a context where \"this\" is a Crypto implementation. Also,\n    // find the complete implementation of crypto (msCrypto) on IE11.\n    getRandomValues = typeof crypto !== 'undefined' && crypto.getRandomValues && crypto.getRandomValues.bind(crypto) || typeof msCrypto !== 'undefined' && typeof msCrypto.getRandomValues === 'function' && msCrypto.getRandomValues.bind(msCrypto);\n\n    if (!getRandomValues) {\n      throw new Error('crypto.getRandomValues() not supported. See https://github.com/uuidjs/uuid#getrandomvalues-not-supported');\n    }\n  }\n\n  return getRandomValues(rnds8);\n}","export default /^(?:[0-9a-f]{8}-[0-9a-f]{4}-[1-5][0-9a-f]{3}-[89ab][0-9a-f]{3}-[0-9a-f]{12}|00000000-0000-0000-0000-000000000000)$/i;","import REGEX from './regex.js';\n\nfunction validate(uuid) {\n  return typeof uuid === 'string' && REGEX.test(uuid);\n}\n\nexport default validate;","import validate from './validate.js';\n/**\n * Convert array of 16 byte values to UUID string format of the form:\n * XXXXXXXX-XXXX-XXXX-XXXX-XXXXXXXXXXXX\n */\n\nvar byteToHex = [];\n\nfor (var i = 0; i < 256; ++i) {\n  byteToHex.push((i + 0x100).toString(16).substr(1));\n}\n\nfunction stringify(arr) {\n  var offset = arguments.length > 1 && arguments[1] !== undefined ? arguments[1] : 0;\n  // Note: Be careful editing this code!  It's been tuned for performance\n  // and works in ways you may not expect. See https://github.com/uuidjs/uuid/pull/434\n  var uuid = (byteToHex[arr[offset + 0]] + byteToHex[arr[offset + 1]] + byteToHex[arr[offset + 2]] + byteToHex[arr[offset + 3]] + '-' + byteToHex[arr[offset + 4]] + byteToHex[arr[offset + 5]] + '-' + byteToHex[arr[offset + 6]] + byteToHex[arr[offset + 7]] + '-' + byteToHex[arr[offset + 8]] + byteToHex[arr[offset + 9]] + '-' + byteToHex[arr[offset + 10]] + byteToHex[arr[offset + 11]] + byteToHex[arr[offset + 12]] + byteToHex[arr[offset + 13]] + byteToHex[arr[offset + 14]] + byteToHex[arr[offset + 15]]).toLowerCase(); // Consistency check for valid UUID.  If this throws, it's likely due to one\n  // of the following:\n  // - One or more input array values don't map to a hex octet (leading to\n  // \"undefined\" in the uuid)\n  // - Invalid input values for the RFC `version` or `variant` fields\n\n  if (!validate(uuid)) {\n    throw TypeError('Stringified UUID is invalid');\n  }\n\n  return uuid;\n}\n\nexport default stringify;","import rng from './rng.js';\nimport stringify from './stringify.js';\n\nfunction v4(options, buf, offset) {\n  options = options || {};\n  var rnds = options.random || (options.rng || rng)(); // Per 4.4, set bits for version and `clock_seq_hi_and_reserved`\n\n  rnds[6] = rnds[6] & 0x0f | 0x40;\n  rnds[8] = rnds[8] & 0x3f | 0x80; // Copy bytes to buffer, if provided\n\n  if (buf) {\n    offset = offset || 0;\n\n    for (var i = 0; i < 16; ++i) {\n      buf[offset + i] = rnds[i];\n    }\n\n    return buf;\n  }\n\n  return stringify(rnds);\n}\n\nexport default v4;","import { v4 as uuidv4 } from 'uuid'\r\nimport {\r\n  CatClientMessageStruct as Message,\r\n  CatClientStruct as Client,\r\n  CatStoreStruct as Store\r\n} from '../types'\r\n\r\nexport default class CatClient implements Client {\r\n  // 核心存储\r\n  private store: Store\r\n  // 主题包\r\n  public themeMap: Map<string, any>\r\n  // 客户端ID\r\n  public clientId: string = uuidv4()\r\n\r\n  /**\r\n   * 初始化\r\n   * @param store\r\n   */\r\n  constructor (store: Store) {\r\n    this.store = store\r\n    this.themeMap = new Map()\r\n    this.connect()\r\n  }\r\n\r\n  /**\r\n   * 建立连接\r\n   */\r\n  public connect () {\r\n    this.store.addClient(this)\r\n  }\r\n\r\n  /**\r\n   * 断开连接\r\n   */\r\n  public disconnect () {\r\n    this.store.delClient(this)\r\n  }\r\n\r\n  /**\r\n   * 发送\r\n   * @param theme\r\n   * @param data\r\n   */\r\n  public send (theme: string, data: any) {\r\n    this.store.taskPush({\r\n      theme,\r\n      clientId: this.clientId,\r\n      timestamp: new Date().getTime(),\r\n      data\r\n    })\r\n  }\r\n\r\n  /**\r\n   * 接收\r\n   * @param theme\r\n   * @param callback\r\n   */\r\n  public receive (theme: string, callback: any) {\r\n    callback && this.themeMap.set(theme, callback)\r\n  }\r\n\r\n  /**\r\n   * 返回待处理主题包\r\n   */\r\n  public getTheme (theme: string): any {\r\n    return (message: Message): Promise<Function> =>\r\n      new Promise(resolve => {\r\n        resolve(this.themeMap.get(theme)(message))\r\n      })\r\n  }\r\n\r\n  /**\r\n   * 主题包是否存在\r\n   */\r\n  public hasTheme (theme: string): boolean {\r\n    return this.themeMap.has(theme)\r\n  }\r\n}\r\n","import {\r\n  CatClientMessageStruct as Message,\r\n  CatServerStruct as Server,\r\n  CatStoreStruct as Store\r\n} from '../types'\r\n\r\nexport default class CatServer implements Server {\r\n  // 核心存储\r\n  private store: Store\r\n\r\n  // 加锁状态\r\n  private lock: null | NodeJS.Timeout = null\r\n\r\n  /**\r\n   * 初始化\r\n   */\r\n  constructor (store: Store) {\r\n    this.store = store\r\n  }\r\n\r\n  // 任务调度\r\n  public dispatch () {\r\n    if (this.lock === null) {\r\n      this.lock = setTimeout(async () => {\r\n        const taskInfo = this.store.taskShift()\r\n        taskInfo && (await this.handler(taskInfo))\r\n        this.lock = null\r\n        this.dispatch()\r\n      })\r\n    }\r\n  }\r\n\r\n  // 处理任务\r\n  private handler (e: Message) {\r\n    return Promise.all(this.store.getClientTheme(e.theme, e))\r\n  }\r\n}\r\n","import {\r\n  CatClientMessageStruct as Message,\r\n  CatServerStruct as Server,\r\n  CatClientStruct as Client,\r\n  CatStoreStruct as Store\r\n} from '../types'\r\nimport CatServer from '../server'\r\n\r\nexport default class CatStore implements Store {\r\n  // 客户端清单\r\n  public clientList: Set<Client>\r\n  // 服务端信息\r\n  public serverInfo: Server\r\n  // 任务清单\r\n  public taskList: Message[]\r\n\r\n  /**\r\n   * 初始化\r\n   */\r\n  constructor () {\r\n    this.serverInfo = new CatServer(this)\r\n    this.clientList = new Set()\r\n    this.taskList = []\r\n  }\r\n\r\n  /**\r\n   * 任务入栈\r\n   */\r\n  public taskPush = (e: Message) => {\r\n    this.taskList.push(e)\r\n    this.serverInfo.dispatch()\r\n  }\r\n\r\n  /**\r\n   * 任务出栈\r\n   */\r\n  public taskShift = (): Message | undefined => {\r\n    return this.taskList.shift()\r\n  }\r\n\r\n  /**\r\n   * 返回客户端主题信息\r\n   * @param theme\r\n   * @param message\r\n   * @returns\r\n   */\r\n  public getClientTheme = (theme: string, message: Message): any[] => {\r\n    const receives: any[] = []\r\n    this.clientList.forEach((item: Client) => {\r\n      if (item.hasTheme(theme)) {\r\n        receives.push(item.getTheme(theme)(message))\r\n      }\r\n    })\r\n    return receives\r\n  }\r\n\r\n  /**\r\n   * 添加客户端信息\r\n   */\r\n  public addClient = (client: Client) => {\r\n    this.clientList.add(client)\r\n  }\r\n\r\n  /**\r\n   * 删除客户端信息\r\n   */\r\n  public delClient = (client: Client) => {\r\n    this.clientList.delete(client)\r\n  }\r\n}\r\n","import CatClient from './client'\r\nimport CatStore from './store'\r\n\r\n// 单例\r\nconst store = new CatStore()\r\n\r\n// 客户端处理核心\r\nconst useCatCore = () => {\r\n  const client = new CatClient(store)\r\n  return client\r\n}\r\n\r\nexport { useCatCore }\r\n"],"names":["getRandomValues","rnds8","rng","REGEX","validate","uuid","byteToHex","i","stringify","arr","offset","v4","options","buf","rnds","CatClient","store","__publicField","uuidv4","theme","data","callback","message","resolve","CatServer","taskInfo","e","CatStore","receives","item","client","useCatCore"],"mappings":"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"}